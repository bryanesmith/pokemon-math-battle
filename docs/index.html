<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pok√©mon Math Battle!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            min-height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            /*transform: scale(0.7);*/
            zoom: 0.65; /* non-standard but transform: scale leaves whitespace at bottom of screen */
            transform-origin: top center;
            margin: 0;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #FFCB05;
            text-shadow: 3px 3px 0px #3D7DCA;
            font-size: 1.5em;
            margin-bottom: 30px;
        }

        .battle-arena {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D98E 100%);
            border-radius: 15px;
            border: 4px solid #2C5F2D;
        }

        .pokemon {
            text-align: center;
        }

        .pokemon-sprite {
            width: 150px;
            height: 150px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            margin-bottom: 10px;
            object-fit: contain;
        }

        .pokemon-name {
            font-size: 0.8em;
            color: #2C5F2D;
            margin-bottom: 10px;
        }

        .health-bar {
            background: #ddd;
            border-radius: 10px;
            height: 25px;
            width: 150px;
            border: 3px solid #333;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6em;
            color: black;
            text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.5);
            overflow: hidden;
        }

        .health-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(to right, #4ade80, #22c55e);
            transition: width 0.5s ease;
            z-index: 1;
        }

        .health-text {
            position: relative;
            z-index: 2;
            pointer-events: none;
        }

        .health-fill.low {
            background: linear-gradient(to right, #fbbf24, #f59e0b);
        }

        .health-fill.critical {
            background: linear-gradient(to right, #ef4444, #dc2626);
        }

        .vs {
            font-size: 2em;
            color: #FF0000;
            text-shadow: 2px 2px 0px #FFCB05;
        }

        .problem-section {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: #FFF3CD;
            border-radius: 15px;
            border: 4px solid #FFD700;
        }

        .problem {
            margin-bottom: 0;
        }

        #problem .formula {
            font-size: 2em;
            color: #333;
        }

        #problem .feedback {
            font-size: 1em;
            line-height: 2em;
            vertical-align: top;
            /* color: #333; // color will be dynamically set */
        }

        .calculator {
            max-width: 400px;
            margin: 0 auto;
            background: linear-gradient(145deg, #6366f1, #8b5cf6);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .calc-display {
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 2.5em;
            padding: 20px;
            border-radius: 10px;
            text-align: right;
            margin-bottom: 20px;
            min-height: 70px;
            border: 3px solid #333;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .calc-btn {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2em;
            padding: 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(145deg, #fbbf24, #f59e0b);
            color: white;
            box-shadow: 0 6px 0 #d97706, 0 8px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.1s;
        }

        .calc-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #d97706, 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .calc-btn:hover {
            background: linear-gradient(145deg, #fcd34d, #fbbf24);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .action-btn {
            font-family: 'Press Start 2P', cursive;
            font-size: 0.9em;
            padding: 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.3), 0 8px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.1s;
        }

        .action-btn.delete {
            background: linear-gradient(145deg, #ef4444, #dc2626);
        }

        .action-btn.clear {
            background: linear-gradient(145deg, #f97316, #ea580c);
        }

        .action-btn.submit {
            grid-column: span 2;
            background: linear-gradient(145deg, #22c55e, #16a34a);
            font-size: 1.1em;
        }

        .action-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.3), 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .action-btn:hover {
            filter: brightness(1.1);
        }

        .instructions {
            background: #E0F2FE;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 3px solid #0EA5E9;
            font-size: 0.6em;
            line-height: 1.6;
            color: #0c4a6e;
        }

        .message {
            text-align: center;
            font-size: 1.2em;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            display: none;
        }

        .message.correct {
            background: #D1FAE5;
            color: #065F46;
            border: 3px solid #10B981;
            display: block;
        }

        .message.incorrect {
            background: #FEE2E2;
            color: #991B1B;
            border: 3px solid #EF4444;
            display: block;
        }

        .message.game-over {
            background: #DBEAFE;
            color: #1E40AF;
            border: 3px solid #3B82F6;
            display: block;
            font-size: 1.5em;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .shake {
            animation: shake 0.3s;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(5deg); }
        }

        .celebrate {
            animation: celebrate 0.5s;
        }

        .defeated-pokemon {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: #F3F4F6;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .defeated-pokemon.show {
            display: flex;
        }

        .defeated-pokemon-icon {
            width: 50px;
            height: 50px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            object-fit: contain;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        .defeated-pokemon-icon:hover {
            opacity: 1;
        }

        .victory-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .victory-content {
            text-align: center;
            color: white;
        }

        .victory-content h2 {
            font-size: 2em;
            color: #FFCB05;
            text-shadow: 3px 3px 0px #3D7DCA;
            margin-bottom: 30px;
            animation: pulse 1s infinite;
        }

        .evolution-animation {
            width: 200px;
            height: 200px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            animation: evolve 2s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes evolve {
            0% { transform: scale(0.5) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }

        @keyframes firework {
            0% { transform: translate(0, 0) scale(0); opacity: 1; }
            100% { transform: translate(var(--x), var(--y)) scale(1); opacity: 0; }
        }

        .firework {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: firework 1s ease-out forwards;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üéÆ POK√âMON MATH BATTLE! üéÆ</h1>
        
        <div class="battle-arena">
            <div class="pokemon">
                <img class="pokemon-sprite" id="playerSprite" src="sprites/1.gif" alt="Bulbasaur">
                <div class="pokemon-name" id="playerName">BULBASAUR</div>
                <div class="health-bar">
                    <div class="health-fill" id="playerHealth"></div>
                    <span class="health-text">HP: 5/5</span>
                </div>
            </div>
            
            <div class="vs">VS</div>
            
            <div class="pokemon">
                <img class="pokemon-sprite" id="enemySprite" src="sprites/109.gif" alt="Team Rocket">
                <div class="pokemon-name">TEAM ROCKET</div>
                <div class="health-bar">
                    <div class="health-fill" id="enemyHealth"></div>
                    <span class="health-text">HP: 3/3</span>
                </div>
            </div>
        </div>

        <div class="problem-section">
            <div class="problem" id="problem"><span class="formula">Loading...</span><span class="feedback"></span></div>
        </div>

        <div class="calculator">
            <div class="calc-display" id="display">0</div>
            <div class="calc-buttons">
                <button class="calc-btn" onclick="inputDigit('7')">7</button>
                <button class="calc-btn" onclick="inputDigit('8')">8</button>
                <button class="calc-btn" onclick="inputDigit('9')">9</button>
                <button class="calc-btn" onclick="inputDigit('4')">4</button>
                <button class="calc-btn" onclick="inputDigit('5')">5</button>
                <button class="calc-btn" onclick="inputDigit('6')">6</button>
                <button class="calc-btn" onclick="inputDigit('1')">1</button>
                <button class="calc-btn" onclick="inputDigit('2')">2</button>
                <button class="calc-btn" onclick="inputDigit('3')">3</button>
                <button class="calc-btn" onclick="inputDigit('0')" style="grid-column: span 3;">0</button>
            </div>
            <div class="action-buttons">
                <button class="action-btn delete" onclick="deleteDigit()">DELETE</button>
                <button class="action-btn clear" onclick="clearDisplay()">CLEAR</button>
                <button class="action-btn submit" onclick="submitAnswer()">SUBMIT ‚ö°</button>
            </div>
        </div>

        <div class="message" id="message"></div>

        <div class="defeated-pokemon" id="defeatedPokemon"></div>
    </div>

    <div class="victory-overlay" id="victoryOverlay">
        <div class="victory-content">
            <h2>üéâ VICTORY! üéâ</h2>
            <img class="evolution-animation" id="evolutionSprite" src="https://archives.bulbagarden.net/media/upload/3/39/Spr_5b_001_m.png" alt="Evolving">
            <p style="font-size: 1.2em; margin-top: 20px;">BULBASAUR EVOLVED INTO IVYSAUR!</p>
        </div>
    </div>

    <script>
        let playerHP = 5;
        let enemyHP = 3;
        let currentAnswer = 0;
        let displayValue = '0';
        let gameOver = false;
        let currentStage = 1; // 1 = Bulbasaur, 2 = Ivysaur, 3 = Venusaur
        let defeatedPokemon = []; // Track defeated Pokemon
        
        const stages = {
            1: {
                playerName: 'BULBASAUR',
                playerSprite: 'sprites/1.gif',
                enemyName: null, // Will be set randomly
                enemySprite: null, // Will be set randomly
                enemyHP: 3,
                evolutionSprite: 'sprites/1.gif'
            },
            2: {
                playerName: 'IVYSAUR',
                playerSprite: 'sprites/2.gif',
                enemyName: null, // Will be set randomly
                enemySprite: null, // Will be set randomly
                enemyHP: 4,
                evolutionSprite: 'sprites/2.gif'
            },
            3: {
                playerName: 'VENUSAUR',
                playerSprite: 'sprites/3.gif',
                enemyName: null, // Will be set randomly
                enemySprite: null, // Will be set randomly
                enemyHP: 5,
                evolutionSprite: 'sprites/3.gif'
            }
        };
        
        const basePokemonHP3 = [
            { name: 'PIDGEY', sprite: 'sprites/16.gif' },
            { name: 'RATTATA', sprite: 'sprites/19.gif' },
            { name: 'SPEAROW', sprite: 'sprites/21.gif' },
            { name: 'ZUBAT', sprite: 'sprites/41.gif' },
            { name: 'MEOWTH', sprite: 'sprites/52.gif' },
            { name: 'PSYDUCK', sprite: 'sprites/54.gif' },
            { name: 'POLIWAG', sprite: 'sprites/60.gif' },
            { name: 'BELLSPROUT', sprite: 'sprites/69.gif' },
            { name: 'TENTACOOL', sprite: 'sprites/72.gif' },
            { name: 'MAGNEMITE', sprite: 'sprites/81.gif' },
            { name: 'DODUO', sprite: 'sprites/84.gif' },
            { name: 'SEEL', sprite: 'sprites/86.gif' },
            { name: 'SHELLDER', sprite: 'sprites/90.gif' },
            { name: 'KRABBY', sprite: 'sprites/98.gif' },
            { name: 'HORSEA', sprite: 'sprites/116.gif' }
        ];
        
        const basePokemonHP4 = [
            { name: 'GEODUDE', sprite: 'sprites/74.gif' },
            { name: 'MACHOP', sprite: 'sprites/66.gif' },
            { name: 'GASTLY', sprite: 'sprites/92.gif' },
            { name: 'ONIX', sprite: 'sprites/95.gif' },
            { name: 'VOLTORB', sprite: 'sprites/100.gif' },
            { name: 'PIDGEOTTO', sprite: 'sprites/17.gif' },
            { name: 'RATICATE', sprite: 'sprites/20.gif' },
            { name: 'ARBOK', sprite: 'sprites/24.gif' },
            { name: 'SANDSLASH', sprite: 'sprites/28.gif' },
            { name: 'GOLBAT', sprite: 'sprites/42.gif' },
            { name: 'GLOOM', sprite: 'sprites/44.gif' },
            { name: 'PERSIAN', sprite: 'sprites/53.gif' },
            { name: 'GOLDUCK', sprite: 'sprites/55.gif' },
            { name: 'POLIWHIRL', sprite: 'sprites/61.gif' },
            { name: 'GRAVELER', sprite: 'sprites/75.gif' },
            { name: 'HAUNTER', sprite: 'sprites/93.gif' }
        ];
        
        const legendaryPokemon = [
            { name: 'ARTICUNO', sprite: 'sprites/144.gif' },
            { name: 'ZAPDOS', sprite: 'sprites/145.gif' },
            { name: 'MOLTRES', sprite: 'sprites/146.gif' },
            { name: 'MEWTWO', sprite: 'sprites/150.gif' },
            { name: 'LUGIA', sprite: 'sprites/249.gif' },
            { name: 'HO-OH', sprite: 'sprites/250.gif' }
        ];

        function displayFormula(formulaText) {
            problemEl = document.getElementById('problem');
            problemEl.querySelector('.formula').textContent = formulaText;
            problemEl.querySelector('.feedback').textContent = '';
        }

        function displayAnswerFeedback(feedbackText, textColor) {
            problemEl = document.getElementById('problem');
            problemEl.querySelector('.formula').textContent = '';
            feedbackEl = problemEl.querySelector('.feedback');
            feedbackEl.textContent = feedbackText;
            feedbackEl.style.color = textColor;
        }

        function generateProblem() {
            let num1, num2;
            const operation = Math.random() > 0.5 ? '+' : '-';
            
            // Adjust difficulty based on stage
            if (currentStage === 1) {
                // Easy: 1-9
                num1 = Math.floor(Math.random() * 9) + 1;
                num2 = Math.floor(Math.random() * 9) + 1;
            } else if (currentStage === 2) {
                // Medium: 1-20
                num1 = Math.floor(Math.random() * 20) + 1;
                num2 = Math.floor(Math.random() * 20) + 1;
            } else {
                // Hard: 1-50
                num1 = Math.floor(Math.random() * 50) + 1;
                num2 = Math.floor(Math.random() * 50) + 1;
            }
            
            if (operation === '+') {
                currentAnswer = num1 + num2;
                displayFormula(`${num1} + ${num2}`);
            } else {
                if (num1 >= num2) {
                    currentAnswer = num1 - num2;
                    displayFormula(`${num1} - ${num2}`);
                } else {
                    currentAnswer = num2 - num1;
                    displayFormula(`${num2} - ${num1}`);
                }
            }
        }

        function inputDigit(digit) {
            if (gameOver) return;
            if (displayValue === '0') {
                displayValue = digit;
            } else {
                displayValue += digit;
            }
            updateDisplay();
        }

        function deleteDigit() {
            if (gameOver) return;
            displayValue = displayValue.slice(0, -1);
            if (displayValue === '') displayValue = '0';
            updateDisplay();
        }

        function clearDisplay() {
            if (gameOver) return;
            displayValue = '0';
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('display').textContent = displayValue;
        }
        
        function getEnemyPokemonName() {
            return document.querySelectorAll('.pokemon-name')[1].textContent;
        }

        function submitAnswer() {
            if (gameOver) return;
            
            const userAnswer = parseInt(displayValue);

            if (userAnswer === currentAnswer) {
                displayAnswerFeedback(`‚ú® Correct! ${getEnemyPokemonName()} takes 1 damage! ‚ú®`, '#16a34a');
                enemyHP--;
                updateHealth();
                document.getElementById('enemySprite').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('enemySprite').classList.remove('shake');
                }, 300);
                
                if (enemyHP === 0) {
                    endGame(true);
                    return;
                }
                
                // Show correct message for 3 seconds
                setTimeout(() => {
                    clearDisplay();
                    generateProblem();
                }, 3000);
            } else {
                currentProblemText = document.getElementById('problem').querySelector('.formula').textContent;
                displayAnswerFeedback(`Uh-oh, ${currentProblemText} = ${currentAnswer}. You take damage.`, '#dc2626');
                playerHP--;
                updateHealth();
                document.getElementById('playerSprite').classList.add('shake');
                setTimeout(() => {
                    document.getElementById('playerSprite').classList.remove('shake');
                }, 300);
                
                if (playerHP === 0) {
                    endGame(false);
                    return;
                }
                
                // Show incorrect message for 5 seconds
                setTimeout(() => {
                    problemEl.style.color = '#333';
                    clearDisplay();
                    generateProblem();
                }, 5000);
            }
        }

        function updateHealth() {
            const playerHealthEl = document.getElementById('playerHealth');
            const enemyHealthEl = document.getElementById('enemyHealth');
            const maxEnemyHP = stages[currentStage].enemyHP;
            
            // Update player health bar
            const playerPercent = (playerHP / 5) * 100;
            playerHealthEl.style.width = `${playerPercent}%`;
            
            // Update enemy health bar
            const enemyPercent = (enemyHP / maxEnemyHP) * 100;
            enemyHealthEl.style.width = `${enemyPercent}%`;
            
            // Update health text
            document.querySelectorAll('.health-text')[0].textContent = `HP: ${playerHP}/5`;
            document.querySelectorAll('.health-text')[1].textContent = `HP: ${enemyHP}/${maxEnemyHP}`;
            
            // Update health bar colors based on remaining health
            if (playerHP <= 1) {
                playerHealthEl.classList.add('critical');
                playerHealthEl.classList.remove('low');
            } else if (playerHP <= 2) {
                playerHealthEl.classList.add('low');
                playerHealthEl.classList.remove('critical');
            } else {
                playerHealthEl.classList.remove('low', 'critical');
            }
            
            if (enemyHP <= 1) {
                enemyHealthEl.classList.add('critical');
                enemyHealthEl.classList.remove('low');
            } else if (enemyHP <= Math.ceil(maxEnemyHP / 2)) {
                enemyHealthEl.classList.add('low');
                enemyHealthEl.classList.remove('critical');
            } else {
                enemyHealthEl.classList.remove('low', 'critical');
            }
        }

        function endGame(won) {
            gameOver = true;
            const problemEl = document.getElementById('problem');
            
            if (won) {
                // Add defeated Pokemon to collection
                defeatedPokemon.push({
                    name: stages[currentStage].enemyName,
                    sprite: stages[currentStage].enemySprite
                });
                updateDefeatedPokemon();
                
                if (currentStage < 3) {
                    // Show evolution and advance to next stage
                    displayAnswerFeedback(`üéâ Congrats - You caught ${getEnemyPokemonName()}!`, '#FFCB05');
                    setTimeout(() => {
                        showEvolutionAnimation();
                    }, 3000);
                } else {
                    // Final victory!
                    displayAnswerFeedback('üèÜ ULTIMATE VICTORY! YOU ARE A POK√âMON MASTER! üèÜ', '#FFCB05');
                    showFinalVictory();
                }
            } else {
                displayAnswerFeedback('üíî GAME OVER! Your Pok√©mon fainted... Try again!', '#dc2626');
                
                setTimeout(() => {
                    if (confirm('Play again?')) {
                        location.reload();
                    }
                }, 3000);
            }
        }
        
        function updateDefeatedPokemon() {
            const container = document.getElementById('defeatedPokemon');
            
            if (defeatedPokemon.length === 0) {
                container.classList.remove('show');
                return;
            }
            
            container.classList.add('show');
            container.innerHTML = '';
            
            defeatedPokemon.forEach(pokemon => {
                const img = document.createElement('img');
                img.src = pokemon.sprite;
                img.alt = pokemon.name;
                img.className = 'defeated-pokemon-icon';
                img.title = pokemon.name;
                container.appendChild(img);
            });
        }
        
        function showEvolutionAnimation() {
            const overlay = document.getElementById('victoryOverlay');
            const victoryContent = overlay.querySelector('.victory-content');
            overlay.style.display = 'flex';
            
            victoryContent.innerHTML = `
                <h2>üéâ EVOLUTION! üéâ</h2>
                <img class="evolution-animation" src="${stages[currentStage].evolutionSprite}" alt="Evolving">
                <p style="font-size: 1.2em; margin-top: 20px;">${stages[currentStage].playerName} EVOLVED INTO ${stages[currentStage + 1].playerName}!</p>
            `;
            
            createFireworks();
            
            setTimeout(() => {
                advanceToNextStage();
            }, 5000);
        }
        
        function showFinalVictory() {
            const overlay = document.getElementById('victoryOverlay');
            const victoryContent = overlay.querySelector('.victory-content');
            overlay.style.display = 'flex';
            
            victoryContent.innerHTML = `
                <h2>üèÜ CHAMPION! üèÜ</h2>
                <img class="evolution-animation" src="${stages[3].playerSprite}" alt="Venusaur">
                <p style="font-size: 1.2em; margin-top: 20px;">YOU DEFEATED THE LEGENDARY POK√âMON!</p>
                <p style="font-size: 1em; margin-top: 10px;">YOU ARE A POK√âMON MASTER!</p>
            `;
            
            createFireworks();
            
            setTimeout(() => {
                overlay.style.display = 'none';
                // Reset game state but keep defeated Pokemon
                currentStage = 1;
                playerHP = 5;
                gameOver = false;
                
                // Set up new stage 1 enemy
                const enemy1 = basePokemonHP3[Math.floor(Math.random() * basePokemonHP3.length)];
                stages[1].enemyName = enemy1.name;
                stages[1].enemySprite = enemy1.sprite;
                
                // Update display
                document.getElementById('playerSprite').src = stages[1].playerSprite;
                document.getElementById('playerName').textContent = stages[1].playerName;
                document.getElementById('enemySprite').src = stages[1].enemySprite;
                const enemyNameElements = document.querySelectorAll('.pokemon-name');
                enemyNameElements[1].textContent = stages[1].enemyName;
                
                enemyHP = stages[1].enemyHP;
                
                // Reset health bars
                const playerHealthEl = document.getElementById('playerHealth');
                const enemyHealthEl = document.getElementById('enemyHealth');
                playerHealthEl.classList.remove('low', 'critical');
                enemyHealthEl.classList.remove('low', 'critical');
                
                updateHealth();
                
                document.getElementById('problem').style.color = '#333';
                clearDisplay();
                generateProblem();
            }, 5000);
        }
        
        function advanceToNextStage() {
            currentStage++;
            
            // Set up enemy Pok√©mon based on stage
            if (currentStage === 1) {
                const enemy = basePokemonHP3[Math.floor(Math.random() * basePokemonHP3.length)];
                stages[1].enemyName = enemy.name;
                stages[1].enemySprite = enemy.sprite;
            } else if (currentStage === 2) {
                const enemy = basePokemonHP4[Math.floor(Math.random() * basePokemonHP4.length)];
                stages[2].enemyName = enemy.name;
                stages[2].enemySprite = enemy.sprite;
            } else if (currentStage === 3) {
                const legendary = legendaryPokemon[Math.floor(Math.random() * legendaryPokemon.length)];
                stages[3].enemyName = legendary.name;
                stages[3].enemySprite = legendary.sprite;
            }
            
            // Hide overlay first
            document.getElementById('victoryOverlay').style.display = 'none';
            
            // Update player sprite and name
            document.getElementById('playerSprite').src = stages[currentStage].playerSprite;
            document.getElementById('playerName').textContent = stages[currentStage].playerName;
            
            // Update enemy sprite and name
            document.getElementById('enemySprite').src = stages[currentStage].enemySprite;
            const enemyNameElements = document.querySelectorAll('.pokemon-name');
            enemyNameElements[1].textContent = stages[currentStage].enemyName;
            
            // Reset enemy HP only (player HP persists!)
            enemyHP = stages[currentStage].enemyHP;
            
            // Reset health bars
            const playerHealthEl = document.getElementById('playerHealth');
            const enemyHealthEl = document.getElementById('enemyHealth');
            enemyHealthEl.classList.remove('low', 'critical');
            
            updateHealth();
            
            // Reset game state
            document.getElementById('problem').style.color = '#333';
            gameOver = false;
            clearDisplay();
            generateProblem();
        }

        function createFireworks() {
            const overlay = document.getElementById('victoryOverlay');
            const colors = ['#FFD700', '#FF69B4', '#00CED1', '#FF6347', '#7FFF00', '#FF1493'];
            
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.left = Math.random() * 100 + '%';
                    firework.style.top = Math.random() * 100 + '%';
                    firework.style.background = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.setProperty('--x', (Math.random() - 0.5) * 200 + 'px');
                    firework.style.setProperty('--y', (Math.random() - 0.5) * 200 + 'px');
                    overlay.appendChild(firework);
                    
                    setTimeout(() => firework.remove(), 1000);
                }, i * 100);
            }
        }

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (gameOver) return;
            
            if (e.key >= '0' && e.key <= '9') {
                inputDigit(e.key);
            } else if (e.key === 'Backspace') {
                e.preventDefault();
                deleteDigit();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                submitAnswer();
            } else if (e.key === 'Escape') {
                clearDisplay();
            }
        });

        // Initialize game
        function initGame() {
            // Set up stage 1 enemy (HP 3)
            const enemy1 = basePokemonHP3[Math.floor(Math.random() * basePokemonHP3.length)];
            stages[1].enemyName = enemy1.name;
            stages[1].enemySprite = enemy1.sprite;
            
            // Update initial enemy display
            document.getElementById('enemySprite').src = stages[1].enemySprite;
            const enemyNameElements = document.querySelectorAll('.pokemon-name');
            enemyNameElements[1].textContent = stages[1].enemyName;
            
            // Initialize health bars
            const playerHealthEl = document.getElementById('playerHealth');
            const enemyHealthEl = document.getElementById('enemyHealth');
            playerHealthEl.style.width = '100%';
            enemyHealthEl.style.width = '100%';
            
            generateProblem();
            updateDisplay();
        }
        
        initGame();
    </script>
</body>
</html>
